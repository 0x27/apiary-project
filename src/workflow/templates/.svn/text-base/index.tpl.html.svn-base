<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Apiary Workflow</title>

	<style type="text/css">


	</style>
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/apiary.css" />
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/progress_nav.css" />
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/rounded_div.css" />
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/tab_bar_nav.css" />
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/colorbox.css" />
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/pagination.css" />
    <link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/jquery.jgrowl.css" />
	<link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/jquery.fastconfirm.css" />
	<link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/style.css" />
	<link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/apiaryOL.css" />
	<link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/superfish.css" />
	<link rel="stylesheet" type="text/css" media="screen,projection" href="assets/css/jquery.treeview.css" />
    <link rel="stylesheet" href="assets/css/jquery.tooltip.css" />


	<!--script type="text/javascript" src="assets/js/jquery-1.5.1.min.js"></script-->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.js"></script>
	<script type="text/javascript" src="assets/js/jquery-ui-1.8.5.custom.min.js"></script>
	<script type="text/javascript" src="assets/js/jquery.layout.js"></script>
	<script type="text/javascript" src="assets/js/jquery.colorbox.js"></script>
	<script type="text/javascript" src="assets/js/jquery.jgrowl_compressed.js"></script>
	<script type="text/javascript" src="assets/js/jquery.fastconfirm.js"></script>
	<script type="text/javascript" src="assets/js/OpenLayers.js"></script>
	<script type="text/javascript" src="assets/js/apiaryOL.js"></script>
	<script type="text/javascript" src="assets/js/apiary.parse.js"></script>
	<script type="text/javascript" src="assets/js/apiary.parse.tinymce.js"></script>
	<script type="text/javascript" src="assets/js/apiary.transcribe.js"></script>
	<script type="text/javascript" src="assets/js/apiary.item_browser.js"></script>
    <script type="text/javascript" src="assets/js/jquery.tooltip.js"></script>
    <script type="text/javascript" src="assets/js/superfish.js"></script>
    <script type="text/javascript" src="assets/js/jquery.treeview.js"></script>
    <script type="text/javascript" src="assets/js/tiny_mce/tiny_mce.js"></script>


    {literal}
    <script type="text/javascript">

	var myLayout; // a var is required because this page utilizes: myLayout.allowOverflow() method
    var centerLayout;
    var permission_list;
    var isGetParseTabLoading = false;

	$(document).ready(function () {
		if(workflow_id == "0" || workflow_id == "" || workflow_id == null)
		{
			alert("No workflow id is assigned. Returning to homepage.");
			window.location.href = drupal_url;
		}

		myLayout = $('body').layout({
			west__showOverflowOnHover:	true
	,	north: {
	        size:                   35
		,   spacing_open:			0			// cosmetic spacing
		,	togglerLength_open:		0			// HIDE the toggler button
		,	togglerLength_closed:	-1			// "100%" OR -1 = full width of pane
		,	resizable: 				false
		,	slidable:				false
		,	fxName:					"none"
		}
	,	west: {
			size:					250
		,	spacing_closed:			21			// wider space when closed
		,	spacing_open:			21			// wider space when closed
		,	togglerLength_closed:	0			// make toggler 'square' - 21x21
		,   togglerLength_open:     0
		,	togglerAlign_closed:	"center"		// align to top of resizer
		,	togglerTip_open:		"Close West Pane"
		,	togglerTip_closed:		"Open West Pane"
		,	resizerTip_open:		"Resize West Pane"
		,	slideTrigger_open:		"mouseover"
		,	initClosed:				true
		,	fxSettings_open:		{ easing: "" }
		,	resizable: 				false
		,	onclose_end:			show_queue_control_open
		,	onopen_end:				show_queue_control_closed
		,   onresize_end:           resize_west_pane
	    }
	,	east: {
			size:					300
		,   minSize:                300
		,	togglerLength_closed:	21			// make toggler 'square' - 21x21
		,	togglerAlign_closed:	"center"		// align to top of resizer
		,	slideTrigger_open:		"click"
		,	initClosed:				false
		,	fxName:					"drop"
		,	fxSpeed:				"normal"
		,	fxSettings:				{ easing: "" } // nullify default easing
		,   onresize_end:           resize_east_pane
		,   onshow_end:             show_east_page
		,	onclose_end:			east_panel_closed
		,	onopen_end:				east_panel_opened
		}
		, south: {
		    onresize_end: adjust_center_overflow
		}		});
		myLayout.addPinBtn( "#queue-info-control", "west" );

		// Do no check this in!!!
     	$('button#end_session_link').colorbox({inline:true, href:"#end_session"});

		$.ajax({
			url: drupal_url+"/apiary/workflow_ajax/create_session/"+workflow_id+"/0/0",
			success: function(data) {
				session_id = $.trim(data);
				if(session_id != null && session_id != 0 && session_id != '' && session_id != 'false') {
					$('.add_items_link').click(function(){
					  load_item_browser();
					});
					load_queue_list();
					$('button#end_session_link').colorbox({inline:true, href:"#end_session"});
					$('button#cancel_end_session').click(function(){
						close_end_session();
					});
					$('button#session_statistics_link').colorbox({inline:true, href:"#session_statistics"});
					$('button#close_session_statistics').click(function(){
						close_session_statistics();
					});
					$('button#confirm_end_session').click(function(){
						end_session();
					});
				}
				else {
					alert("Unable to attain session id, returning to drupal homepage.");
					window.location.href = drupal_url;
				}
			},
			error: function() {
			    {/literal}
			    {if $smarty.get.debug == ''}
				alert("You must be logged in and have permissions to View the Apiary Project to view this page.");
				window.location.href = drupal_url;
				{/if}
				{literal}
			}
		});
		$.ajax({
			url: drupal_url+"/apiary/workflow_ajax/get_permissions/"+workflow_id+"/0/0",
			success: function(results) {
				data = $.parseJSON(results);
			    selected_permission_list =  $.trim(data.selected_permission_list);
			    permission_list = selected_permission_list.split(",");
			    setup_permission_map();
			    //console.log(permission_map);
			    init_user_interface();
			},
			error: function() {
			    alert('error getting permissions.');
			    init_user_interface();
			}
		});

 	});

	</script>
	{/literal}

</head>
<body>
<!-- manually attach allowOverflow method to pane -->
<div class="ui-layout-north" onmouseover="myLayout.allowOverflow('north')" onmouseout="myLayout.resetOverflow(this)">
{include file="workflow-north-content.tpl.html"}
</div><!-- .ui-layout-north -->

<div class="ui-layout-south">
{include file="workflow-south-content.tpl.html"}
</div><!-- .ui-layout-south -->

<div class="ui-layout-east" >
{include file="workflow-east-content.tpl.html"}
</div><!-- .ui-layout-east -->

<!-- allowOverflow auto-attached by option: west__showOverflowOnHover = true -->
<div class="ui-layout-west" onmouseover="hide_popupall();">
{include file="workflow-west-content.tpl.html"}
</div>


<div class="ui-layout-center" onmouseover="hide_popupall();">
{include file="workflow-center-content.tpl.html"}
</div><!-- .ui-layout-center -->

<div class="_wai">
	<div id="roi-popup" title="ROI">
    <img src="assets/img/honey.png"/>
	</div><!-- End #roi-popup -->
</div><!-- End .wai -->

<div class="nothing" style="display:none;">
    <div class="" id="session_statistics">
        <div class="dialog_box_title">
            <div class="tl"><div class="tr">
            <h3>Session Statistics</h3>
            </div></div>
        </div>
        <div class="dialog_box_content">
        	<br/>
            This feature is not yet implemented<br/>
        	<br/>
    		<div id="session_overlay_buttons">
        		<button id="close_session_statistics" style="float:right;" value="close_session_statistics" class="customBtn" ><span>Close</span></button>
        	</div>
        </div>
    </div>
</div>

<div class="nothing" style="display:none;">
    <div class="" id="end_session">
        <div class="dialog_box_title">
            <div class="tl"><div class="tr">
            <h3>End this session?</h3>
            </div></div>
        </div>
        <div class="dialog_box_content">
            Would you like to end this session?
            <br/>
            <br/>You have X objects that are marked as "in progress".
            <br/>If you end this session, these will be changed to "incomplete".
            <br/>
            <br/>All objects in your queue will be removed so others can work on them.
            <br/>
    		<div id="session_overlay_buttons">
    			<button id="cancel_end_session" value="cancel_end_session" class="customBtn" ><span class="singleLine">Cancel</span></button>
    			<button id="confirm_end_session" value="confirm_end_session" class="customBtn" ><span class="singleLine">Yes</span></button>
        	</div>
        </div>
    </div>
</div>

<div class="nothing" style="display:none;">
    <div class="" id="add_note">
        <div class="dialog_box_title">
            <div class="tl"><div class="tr">
            <h3>Add a note</h3>
            </div></div>
        </div>
        <div class="dialog_box_content">
            <textarea id="add_note_textarea" cols=40 rows=6 ></textarea><br/>
    		<div id="session_overlay_buttons">
        		<span>
        			<button id="add_note_button" value="add_note" class="customBtn" ><span>Save</span></button>
        			<button id="cancel_note_button" value="cancel_note" class="customBtn" ><span>Cancel</span></button>
        		</span>
        	</div>
        </div>
    </div>
</div>

<div class="nothing" style="display:none;">
  <div id="item_browser">Please wait for the item browser to load...</div>
  <div style="width:50px">&nbsp;</div>
</div>

<div class="nothing" style="display:none;">
  <div id="item_browser_items"></div>
  <div style="width:50px">&nbsp;</div>
</div>

<div class="nothing" style="display:none;">
  <div id="ubio_results"></div>
  <div style="width:50px">&nbsp;</div>
</div>

<div class="nothing" style="display:none;">
<div id="empty_queue_message" style="width:60%;height:100%;text-align:left">
<h3>Welcome to the Apiary Workflow</h3><br>
Your task queue is currently empty. The first step in the workflow is to choose specimens you want to work on.<br><br>
To add multiple specimens to your queue:<br>
<b>1.</b> Move your mouse pointer to the left of the web browser window to the tab in the bottom left that says "My Queue". This will open your task queue.<br>
<b>2.</b> Click on the button labeled "Add Items". This will open the specimen browser.<br>
<b>3.</b> Select which items you want to work on by clicking on each then clicking on the button labeled "Add to Queue" in the bottom right of the item browser window.<br><br>

If you would like <b>to simply add the next available specimen</b> one at a time, you can <b>click the "+"</b> icon to the right of the specimen preview located in the bottom left of the browser window.<br><br>

After you've added specimens to your queue, you can begin your work. Use the contextual help links throughout the interface to learn more about the various features. The "Getting Started" link in the top right will give you an overview of the process and help you quickly become productive in the workflow.
</div><!--empty_queue_message-->
</div>

<div class="nothing" style="display:none;">
<div id="no_selected_specimen_message" style="width:60%;height:100%;text-align:left">
<h3>Welcome to the Apiary Workflow</h3><br>
You now have items in your task queue.<br>
To begin work on any item, move your mouse cursor to the left edge of this browser window which will open your task queue. To select any item to work on, click on it in the task list.
</div><!--no_selected_specimen_message-->
</div>

<div class="_roundedcornr_ltgray" id="widget-menu-dialog" style="display:none;">
    <div class="widget-menu-dialog-icon floatleft" onclick="close_specimen_dialog();"></div>
<!--div class="widget-menu-dialog-exit-control floatright" onclick="close_specimen_dialog();"></div-->
        <a href="#" onclick="take_action_specimen_menu('remove'); return false;">Remove specimen</a>
</div><!-- .roundedcornr_ltgray -->


</body>
</html>

{literal}
<script type="text/javascript">

    var current_specimen = '00000003-C5BE-11DF-AD1A-7377DFD72085';
    var current_user = '23E9AD58-C5BE-11DF-B2AA-7A77DFD72085';
    var workflow_id = '{/literal}{$workflow_id}{literal}';
    var epp = '{/literal}{$epp}{literal}';
    var page = '{/literal}{$page}{literal}';
    var drupal_url = '{/literal}{$drupal_url}{literal}';
    var djatoka_url = '{/literal}{$djatoka_url}{literal}';
	var current_page = '#add_items_page_1';
	var last_items_page = '';
	var selected_items = new Array();
	var item_browser_loaded = false;
	var session_id = '';
	var permission_map = new Array();

    function setup_permission_map()
    {
        if(permission_list != null)
        {
			$.each(permission_list, function(i, permission) {
				permission_map[permission] = true;
			});
        }
    }

    function init_user_interface()
    {
		$("#roi-preview-001").colorbox({width:"480px", inline:true, href:"#roi-popup", onLoad:function(){
          $("#roi-popup").html("<img src=\"assets/img/honey.png\"/>");
        }});

        $('.ui-layout-resizer-west').addClass('needs_queue_tab'); //ui-layout-resizer-west-closed
        select_tab('tab_nav','tab1','tab1_section');
        select_tab('parse_tab_nav','tab1','parse_tab1_section');
        $('#step1').addClass('selected');
        //$('body *').tooltip({delay:0});
        $('#next_arrow').hide();
        $('#prev_arrow').hide();
        $('#next_add').show();
        $('#prev_placeholder').show();

		$('#add_note_link').colorbox({inline:true, href:"#add_note"});
		$('button#add_note_button').click(function(){
			save_note();
		});
		$('button#cancel_note_button').click(function(){
			cancel_note();
		});

		/*centerLayout = $('.ui-layout-center').layout({
		    name: "center-layout"
		    , center__paneSelector:	"#center-center"
		    , south__paneSelector:	"#center-south"
		});*/
        //alert($('textarea#transcribe_control').val());
		try
		{
			tinyMCE.init({
				// General options
				//mode : "textareas",
				mode : "specific_textareas",
				editor_selector : "transcribe_control",
				theme : "advanced",
				plugins : "transcribeapiary,fullscreen",
				theme_advanced_buttons3_add : "",


				// Theme options
				theme_advanced_buttons1 : "",
				theme_advanced_buttons2 : "",
				theme_advanced_buttons3 : "",
				theme_advanced_buttons4 : "",
				theme_advanced_toolbar_location : "",
				theme_advanced_toolbar_align : "",
				theme_advanced_statusbar_location : "bottom",
				theme_advanced_resizing : true,
				theme_advanced_path : true,

				force_br_newlines : false,
				force_p_newlines : false,
				content_css : "assets/css/apiary.tinymce.css"
			});
			tinyMCE.execCommand('mceAddControl',true,'transcribe_control');
		}
		catch(e)
		{
			alert("Unable to load Who and When TinyMCE");
		}

        $('#step2_section').hide();
        $('#step3_section').hide();

        //select_nav('step1');
        $('ul.sf-menu').superfish();
        $('#parse-treeview').treeview();

        update_progress_nav(); // Disable any progress nav sections that the user doesn't have access to.
        $(window).resize(resize_center_panel);
    }

    function update_progress_nav()
    {
        {/literal}
        {if !$smarty.get.debug}
        disable_nav('step1');
        disable_nav('step2');
        disable_nav('step3');
        {/if}
        {literal}
        if ( permission_map['canQC'] )
        {
            enable_nav('step1');
            enable_nav('step2');
            enable_nav('step3');
        }
        if ( permission_map['canAnalyzeSpecimen'] )
        {
            enable_nav('step1');
        }
        if ( permission_map['canTranscribe'] )
        {
            enable_nav('step2');
            if ( !permission_map['canAnalyzeSpecimen'] && !permission_map['canQC'] )
                select_nav('step2');
        }
        if ( permission_map['canParseL1']
              || permission_map['canParseL2']
              || permission_map['canParseL3'] )
        {
            enable_nav('step3');
            if ( !permission_map['canAnalyzeSpecimen'] && !permission_map['canTranscribe'] && !permission_map['canQC'] )
                select_nav('step3');
        }
    }

    function enable_nav(nav_id)
    {
        $('#'+nav_id).removeClass('disabled');
        $('#'+nav_id).click(function() {
            select_nav(nav_id);
        });
    }

    function disable_nav(nav_id)
    {
        $('#'+nav_id).addClass('disabled');
        $('#'+nav_id).attr('onclick','');
    }

    function hide_popupall()
    {
        hide_popupleft();
        hide_popupcenter();
        hide_popupright();
    }

    function show_popupleft(_this)
    {
        get_prev_specimen();
        myLayout.allowOverflow(_this);$('#popupleft').show();
        $('#previous_specimen').html('<a href="#" onclick="get_prev_specimen();"><img src="assets/img/specimen_next.jpg"/></a>');
    }

    function hide_popupleft()
    {
        myLayout.allowOverflow(this);$('#popupleft').hide();
        $('#previous_specimen').html('');
    }

    function show_popupright(_this)
    {
        get_next_specimen();
        myLayout.allowOverflow(_this);$('#popupright').show();
    }

    function hide_popupcenter()
    {
        myLayout.allowOverflow(this);$('#popupcenter').hide();
    }

    function show_popupcenter(_this)
    {
        step_id = $('.breadcrumbs > li.selected').attr("id");
        if ( step_id != 'step1' )
        {
            myLayout.allowOverflow(_this);
            $('#popupcenter').show();
        }
    }

    function hide_popupright()
    {
        myLayout.allowOverflow(this);$('#popupright').hide();
        $('#next_specimen').html('');
    }

    function get_selected_image_pid()
    {
        current_image_pid = $('.selected_specimen > .widget-header-left > .specimen_name').attr('image_pid');
        return current_image_pid;
    }

    function select_specimen(specimen_id, load_first_roi)
    {
    	if(load_first_roi == null)
    	{
    		load_first_roi = true;
    	}
   	    var stage = get_stage();
   	    if ( stage != 'analysis' )
            select_nav('step1');
        roi_scroll_index = 0;
        $.jGrowl(' selecting '+specimen_id);
        var div_id = get_roi_queue_id(specimen_id);
        $('.widget-header').removeClass('selected_specimen');
        $('.selected_roi').removeClass('selected_roi');
        $('#'+div_id).addClass('selected_specimen');
        update_info_sections();
        make_current_specimen(specimen_id);
        if(load_first_roi)
        {
        	select_first_roi();
        }
        resize_east_pane();
    }

    function select_first_roi() {
    	if($('.selected_specimen').length > 0)
    	{
    		var selected_div = $('.selected_specimen').attr('id');
    		var content_div = "content-"+selected_div.replace('_queue', '');
    		roi_count = $("#"+content_div+" .roi_queued").length;
    		if(roi_count > 0)
    		{
    			var roi_queue_div_id = $("#"+content_div+" .roi_queued").first().attr("id");
    			var roi_pid = $("#"+roi_queue_div_id+" .roi_name").attr("roi_pid");
				load_transcribe_content(roi_pid);
				load_parse_tab(roi_pid);
    		}
    	}
    }

    function remove_specimen(specimen_id)
    {
        pid = get_real_id(specimen_id);
        $.jGrowl('removing '+pid+' from your work queue.');
        remove_queue_item_from_queue(pid);
        resize_center_panel();
    }

    function get_queued_specimen_count() {
      specimen_count = $('.specimen_queued').length;
      return specimen_count;
    }

    function get_queued_roi_count() {
      roi_count = $('.roi_queued').length;
      return roi_count;
    }

    function queued_roi_count_for_current_image() {
    	if($('.selected_specimen').length > 0)
    	{
    		var selected_div = $('.selected_specimen').attr('id');
    		var content_div = "content-"+selected_div.replace('_queue', '');
    		roi_count = $("#"+content_div+" .roi_queued").length;
    		return roi_count;
    	}
    	return 0;
    }

    function update_info_sections()
    {
        specimen_count = get_queued_specimen_count();
        if(specimen_count == 0)
        {
        	$("#map").html($("#empty_queue_message").clone());
        }
        else if(!$('.selected_specimen').length)
        {
        	$("#map").html($("#no_selected_specimen_message").clone());
        }
        $('#queue-info-specimen-count').html(specimen_count);
        roi_count = get_queued_roi_count();
        $('#queue-info-roi-count').html(roi_count);
        specimen_pid = $('.selected_specimen > .widget-header-left > .specimen_name').attr('specimen_pid');
        current_image_id = $('.selected_specimen > .widget-header-left > .specimen_name').attr('image_id');
        //alert('current_image_id= ' + current_image_id );
        if ( specimen_pid != undefined )
        {
            $('#current_specimen_name').html(specimen_pid);
            //current_step = $('#progress_nav > div > ul > li.selected').attr('id');
            current_step = $('ul.breadcrumbs > li.selected').attr('step');
            if ( current_step != undefined )
            {
                $('#current_specimen_stage').html(current_step);
                $('#current_specimen_stage_hyphen').show();
            }
            if ( current_image_id != undefined )
            {
                //nice_image_name = get_nice_id(specimen_pid);
                //alert('<img src="images/'+nice_image_name+'.jpg"/>');
                $('#current_specimen > a').html('<img class="current_specimen_image" src="'+current_image_id+'"/>');
            }
            current_specimen_dom_position = get_dom_position($('.selected_specimen'));
            dom_index = current_specimen_dom_position ;

            // Update the image in the popup-right (next) widget control.
            next_image_id = $('div#queue_list > div.widget-header:gt('+dom_index+'):first > div > div').attr('image_id');
            if ( next_image_id != undefined && next_image_id != current_image_id )
            {
                $('#next_arrow').show();
                $('#next_add').hide();
                $('#next_specimen_image').html('<img src="'+next_image_id+'"/>');
            }
            else if ( next_image_id == current_image_id || next_image_id == undefined )
            {
                hide_popupall();
                $('#next_arrow').hide();
                $('#next_add').show();
            }
            else
                $('#next_specimen_image').html('<img src="assets/img/specimen_current.jpg"/>');

            // Update the image in the popup-left (previous) widget control.
            prev_dom_index = dom_index;
            prev_image_id = $('div#queue_list > div.widget-header:lt('+prev_dom_index+'):last > div > div').attr('image_id');
            if ( prev_image_id != undefined && prev_image_id != current_image_id )
            {
                $('#prev_arrow').show();
                $('#prev_placeholder').hide();
                $('#prev_specimen_image').html('<img class"prev_specimen_image" src="'+prev_image_id+'"/>');
            }
            else if ( prev_image_id == current_image_id || prev_image_id == undefined )
            {
                hide_popupall();
                $('#prev_arrow').hide();
                $('#prev_placeholder').show();
            }
            else
                $('#prev_specimen_image').html('<img class"next_specimen_image" src="assets/img/specimen_current.jpg"/>');

            // Populate the popup-center widget with roi items.
            image_pid = get_selected_image_pid();
            content_id = get_roi_content_id(image_pid);
            new_content = " ";
            visible = "";
            $('div#'+content_id+' > div > div > div.roi_name').each(function(index){
                roi_name = $(this).attr("roi_pid").replace('ap-roi:', '');
                if ( index > 2 )
                    visible = "hide";
                new_content += "<div class=\"roi_item floatleft "+visible+"\" id=\""+roi_name+"_control\" roi_pid=\""+$(this).attr("roi_pid")+"\"style=\"background:#ddd;\"><img src=\"assets/img/roi_icon.png\" height=30px onclick=\"roi_activate('"+roi_name+"_control');\" /> "+roi_name+"</div>";
            });
            $('div#popupcenter-content').html(new_content);
        }
        else
        {
            $('#current_specimen_stage').html('');
            $('#current_specimen_name').html('No specimen currently selected');
            $('#current_specimen_stage_hyphen').hide();
        }

        var selected_roi = get_roi_name();
        if ( selected_roi == '' || selected_roi == null )
        {
            $('#current_roi_name').html('No roi currently selected');
            $('#current_roi_stage').html('');
            $('#current_roi_stage_hyphen').hide();
        }
        else
        {
            $('#current_roi_name').html(selected_roi);

        }
        var status = '';
        var stage = get_stage();
        if ( stage == 'parse' )
        {
            status = $('.selected_roi .parse_status').html();
            if ( status != null )
                status = status.replace('[','').replace(']','').replace(' - ','');
            else
                status = '';
        }
        else if ( stage == 'transcribe' )
        {
            status = $('.selected_roi .transcribe_status').html();
            if ( status != null )
                status = status.replace('[','').replace(']','').replace(' - ','');
            else
                status = '';
        }
        else
        {
            status = $('.selected_specimen .specimen_status').html();
            if ( status != null )
                status = status.replace('[','').replace(']','').replace(' - ','');
            else
                status = '';
        }
 //       alert(status);
        $('#object_status').val(status);
        //$("#specimen_status_dropdown option[value='"+status+"']").attr('selected', 'selected');
        resize_east_pane();
    }

    function load_queue_list()
    {
		$("#queue_list").load(drupal_url+"/apiary/workflow_ajax/queue_list/"+workflow_id+"/0/0", function() {
			var found_image = false;
			if($("#queue_list .specimen_name").first().length) {
				//means we have an image in the queue
				var specimen_pid = $("#queue_list .specimen_name").first().attr("specimen_pid");
				var image_pid = $("#queue_list .specimen_name").first().attr("image_pid");
				found_image = true;
				select_specimen(image_pid);
			}
			update_info_sections();
		});
    }

    function get_next_specimen()
    {
        var current_specimen_id = $('#current_specimen_id').html();
        $("#next_specimen_id").load('get_next_specimen.php?current_specimen='+current_specimen_id, function() {
            var specimen_id = $('#next_specimen_id').html();
            if ( specimen_id != '' )
            {
                $('#next_arrow').show();
                $('#next_add').hide();
                $('#next_specimen').html('<a href="#" onclick="make_next_specimen_current();"><img src="images/'+specimen_id+'_t3.jpg"/></a>');
            }
            else
            {
                hide_popupall();
                $('#next_arrow').hide();
                $('#next_add').show();
                //$('#next_specimen').html('<img src="assets/img/NextAdd.png"/>');
            }

    	});
    }

    function get_prev_specimen()
    {
        var current_specimen_id = $('#current_specimen_id').html();
        $("#prev_specimen_id").load('get_prev_specimen.php?current_specimen='+current_specimen_id, function() {
            var specimen_id = $('#prev_specimen_id').html();
            if ( specimen_id != '' )
            {
                $('#prev_arrow').show();
                $('#prev_placeholder').hide();
                $('#previous_specimen').html('<a href="#" onclick="make_prev_specimen_current();"><img src="images/'+specimen_id+'_t3.jpg"/></a>');
            }
            else
            {
                hide_popupall();
                $('#prev_arrow').hide();
                $('#prev_placeholder').show();
                //$('#next_specimen').html('<img src="assets/img/NextAdd.png"/>');
            }

    	});
    }

    function make_next_specimen_current()
    {
        if ( $('.selected_specimen').length > 0 )
        {
            current_specimen_dom_position = get_dom_position($('.selected_specimen'));
            dom_index = current_specimen_dom_position;
            $('.widget-header').removeClass('selected_specimen');
            //$('div#queue_list > div.widget-header:gt('+dom_index+'):first').addClass('selected_specimen');
            image_pid = $('div#queue_list > div.widget-header:gt('+dom_index+'):first > div > div').attr("image_pid");
            select_specimen(image_pid);
        }
        else
        {
            image_pid = $('div#queue_list > div.widget-header:first > div > div').attr('image_pid');
            select_specimen(image_pid);
        }
        update_info_sections();
    }

    function make_prev_specimen_current()
    {
        if ( $('.selected_specimen').length > 0 )
        {
            current_specimen_dom_position = get_dom_position($('.selected_specimen'));
            dom_index = current_specimen_dom_position;
            $('.widget-header').removeClass('selected_specimen');
            //$('div#queue_list > div.widget-header:lt('+dom_index+'):last').addClass('selected_specimen');
            image_pid = $('div#queue_list > div.widget-header:lt('+dom_index+'):last > div > div').attr("image_pid");
            select_specimen(image_pid);
        }
        else
            $('div#queue_list > div.widget-header:first').addClass('selected_specimen');
        update_info_sections();
    }

    function add_to_queue()
    {
        $.jGrowl(' requesting next item...');
        add_next_item_to_queue();

        /*var current_specimen_id = $('#current_specimen_id').html();
        if ( current_specimen_id != '' )
        {
            $('#prev_specimen_id').html(current_specimen_id);
        }
        $("#current_specimen_id").load('add_to_queue.php?current_user='+current_user, function() {
            var specimen_id = $('#current_specimen_id').html();
            if ( specimen_id != '' )
            {pos.offsetTop
                $('#prev_arrow').show();
                $('#prev_placeholder').hide();
                $('#current_specimen').html('<img src="images/'+specimen_id+'_t3.jpg"/>');
                $('#current_specimen_image').html('<img src="images/'+specimen_id+'_f.jpg"/>');
            }
    	});*/
    }

    function toggle_specimen(id_string)
    {
        //alert('#'+id_string);
        if( $('#'+id_string+':visible').size() == 0 )
            $('#'+id_string).slideDown(500,setControlIcon(id_string,true));
        else
            $('#'+id_string).slideUp(500,setControlIcon(id_string,false));
    }

    function open_specimen_menu(id_string)
    {
        //alert(jQuery('#menu-'+id_string).html());
        var pos = getPosition(document.getElementById('menu-'+id_string));
        $('#widget-menu-dialog').show();
        $('#widget-menu-dialog').attr('target',id_string);
        $('#widget-menu-dialog').css('top',pos.offsetTop+'px');
        $('#widget-menu-dialog').css('left',pos.offsetLeft+'px');
        myLayout.open('west');
    }

    function getPosition(element)
    {
        var left = 0;
    	var top = 0;
	    if(element.offsetParent)
	    {
    	    while(element)
    	    {
    			left += element.offsetLeft;
    			top += element.offsetTop;
    			element = element.offsetParent;
    		}
		}
    	return {offsetLeft: left, offsetTop: top};
    }

    function take_action_specimen_menu(action)
    {
        var target = $('#widget-menu-dialog').attr('target');
        if ( action == 'remove' )
        {
            remove_specimen(target);
        }
        close_specimen_dialog();
    }

    function close_specimen_dialog()
    {
        $('#widget-menu-dialog').hide();
    }

    function toggle_accordion(id_string)
    {
        if( $('#'+id_string+':visible').size() == 0 )
        {
            $('.accordion-content').slideUp(500,setControlIcon(id_string,false));
            $('#'+id_string).height($('#step3_east_section').height()-190);
            $('#'+id_string).slideDown(500,setControlIcon(id_string,true));
        }
        else
            $('#'+id_string).slideUp(500,setControlIcon(id_string,false));
    }

    function setControlIcon(id_string,toggle_flag)
    {
        //alert(id_string);
        var control_id = id_string;
        control_id = control_id.replace("content-", "control-");
        //alert(control_id);
        if( !toggle_flag )
        {
            $('#'+control_id).html('<img src="assets/img/icon_closed.png">');
        }
        else
        {
            $('#'+control_id).html('<img src="assets/img/icon_open.png">');
        }
    }

    function select_nav(class_string)
    {
		if ( class_string == "step1" && ( !permission_map['canAnalyzeSpecimen'] && !permission_map['canQC'] ) )
        {
            alert("You don't have permission to analyze specimen data");
            return false;
        }
        else if ( class_string == "step2" && ( !permission_map['canQC'] && !permission_map['canTranscribe'] ) )
        {
            alert("You don't have permission to transcribe data");
            return false;
        }
        else if ( class_string == "step3" && ( !permission_map['canQC'] && !permission_map['canParseL1'] && !permission_map['canParseL2'] && !permission_map['canParseL3'] ) )
        {
            alert("You don't have permission to parse data");
            return false;
        }

    	if(get_queued_specimen_count() == 0 && class_string == "step2")
    	{
    		alert("You must add an item to your queue to transcribe text.");
    	}
    	else if(get_queued_specimen_count() == 0 && class_string == "step3")
    	{
    		alert("You must add an item to your queue to parse text.");
    	}
    	else if(!$(".selected_specimen").length && class_string == "step2")
    	{
    		alert("You must select an item from your queue to transcribe text.");
    	}
    	else if(!$(".selected_specimen").length && class_string == "step3")
    	{
    		alert("You must select an item from your queue to parse text.");
    	}
    	else if(queued_roi_count_for_current_image() == 0 && class_string == "step2")
    	{
    		alert("There are no queued ROIs for this specimen. Please create an ROI to transcribe text.");
    	}
    	else if(queued_roi_count_for_current_image() == 0 && class_string == "step3")
    	{
    		alert("There are no queued ROIs for this specimen. Please create an ROI to parse text.");
    	}
    	else
    	{
            myLayout.open('east');
        	//alert(class_string);
        	$('#progress_nav').removeClass('step1');
        	$('#progress_nav').removeClass('step2');
        	$('#progress_nav').removeClass('step3');
        	$('#step1_section').hide();
        	$('#step2_section').hide();
        	$('#step3_section').hide();
        	$('#step1_east_section').hide();
        	$('#step2_east_section').hide();
        	$('#step3_east_section').hide();
        	$('.step').removeClass('selected');
        	$('.'+class_string).addClass('selected');

        	$('#progress_nav').addClass(class_string);
        	$('#'+class_string+'_section').show();
        	$('#'+class_string+'_east_section').show();
        	if ( class_string == 'step1' )
        	    $('#roi_legend').show();
        	else
        	    $('#roi_legend').hide();

        	/*if ( class_string == 'step1' )
        	    myLayout.open('east');
        	else
        	    myLayout.close('east')*/
        	if ( class_string == 'step1' )
        	{
        	    myLayout.sizePane('east',300);
        	    //centerLayout.hide('south');
        	    //centerLayout.sizePane('south',100);
                $('#step1_section').show();
                $('#step2_section').hide();
                $('#step3_section').hide();
        	}
        	if ( class_string == 'step2' )
        	{
        	    myLayout.sizePane('east',500);
        	    //centerLayout.hide('south');
        	    //centerLayout.sizePane('south',100);
                $('#step2_section').show();
                $('#step3_section').hide();
                $('#step1_section').hide();
        	}
        	if ( class_string == 'step3' )
        	{
        	    myLayout.sizePane('east',400);
        	    //centerLayout.show('south');
        	    //centerLayout.sizePane('south',100);
                $('#step3_section').show();
                $('#step1_section').hide();
                $('#step2_section').hide();
        	}
        	update_info_sections();
        }
    }

    function select_tab(tab_id, class_string, tab_section_id)
    {
        $('.step').removeClass('selected');
        //alert(class_string);
        $('#'+tab_id).removeClass('tab1');
        $('#'+tab_id).removeClass('tab2');
        $('#'+tab_id+' .tab_section').hide();
        //$('#'+tab_id+' .tab_section').hide();

        $('#'+tab_id).addClass(class_string);
        //$('#'+tab_id).addClass('selected');
        $('#'+tab_id+' #'+tab_section_id).show();
    }

    function setbg(color)
    {
        $('#transcribe_control').css('background-color',color);
    }

    function open_popup(target_page)
    {
        if ( target_page != '' )
        {
            var features = 'width=540,height=600,top=30,left=30,resizable=yes,scrollbars=yes,toolbar=no,location=no,menubar=no,status=no';
            var open_string = '';

            var noteWin = window.open(target_page,'_apiaryHelp', features);
            noteWin.focus();
        }
    }

    var roi_scroll_index = 0;
    function roi_scroll_down()
    {
        roi_item_hide_all();
        roi_scroll_index++;
        roi_count = $('.roi_item').length;
        //alert(roi_count);
        if ( roi_scroll_index > roi_count - 2 )
            roi_scroll_index = roi_count - 2;
        var index = roi_scroll_index-1;
        $('.roi_item:gt('+index+'):first').show();
        index++;
        $('.roi_item:gt('+index+'):first').show();
        index++;
        $('.roi_item:gt('+index+'):first').show();
    }

    function roi_scroll_up()
    {
        roi_item_hide_all();
        roi_scroll_index--;
        if ( roi_scroll_index < 0 )
            roi_scroll_index = 0;
        var index = roi_scroll_index-1;
        if ( index == -1 )
            $('.roi_item:first').show();
        else
            $('.roi_item:gt('+index+'):first').show();
        index++;
        $('.roi_item:gt('+index+'):first').show();
        index++;
        $('.roi_item:gt('+index+'):first').show();
    }

    function roi_item_hide_all()
    {
        $('.roi_item').hide();
    }

    function roi_activate(item)
    {
        roi_pid = $('#'+item).attr("roi_pid");
        //alert('activate roi='+roi_pid);
        var stage = get_stage();
        if ( stage == 'transcribe' )
            transcribe_roi(roi_pid);
        else
            parse_roi(roi_pid)
    }

    function toggle_selected(item)
    {
    	var pid = item.substr(1).replace("__", ":");
        if ( $(item).hasClass('unselected') )
        {
        	selected_items.push(pid);
            $(item).removeClass('roundedcornr_ltgray');
            $(item).addClass('roundedcornr_dgray');
            $(item).removeClass('unselected');
            $(item).addClass('selected');
        }
        else
        {
        	var pid_index = selected_items.indexOf(pid);
        	selected_items.splice(pid_index,1);
            $(item).removeClass('roundedcornr_dgray');
            $(item).addClass('roundedcornr_ltgray');
            $(item).removeClass('selected');
            $(item).addClass('unselected');
        }
    }

    function hide_all_pages()
    {
        {/literal}
        {foreach from=$item_pool key=key item=current_row name=this_foreach}
        {if $smarty.foreach.this_foreach.iteration % 10 == 1}
        $('#add_items_page_{floor param=$smarty.foreach.this_foreach.iteration/10+1}').hide();
        $('#add_items_page_{floor param=$smarty.foreach.this_foreach.iteration/10+1}_control').removeClass('current');
        {/if}
        {/foreach}
        {literal}
    }

    function delete_roi_from_queue(roi_pid){
    	var queue_id = get_roi_queue_id(roi_pid);
    	var image_pid = $("#"+queue_id+" .roi_name").attr("image_pid");
    	$("#"+queue_id).remove();
    	decrease_image_roi_count(image_pid);
    }

    function increase_image_roi_count(image_pid){
    	//span id in the form of roi_count_ap-image__Image-1
    	var roi_count_id = 'roi_count_'+image_pid.replace(':', '__');
    	var count = $('#'+roi_count_id).html();
    	count = parseInt(count);
    	count = count + 1;
    	$('#'+roi_count_id).html(count);
    }

    function decrease_image_roi_count(image_pid){
    	//span id in the form of roi_count_ap-image__Image-1
    	var roi_count_id = 'roi_count_'+image_pid.replace(':', '__');
    	var count = $('#'+roi_count_id).html();
    	count = parseInt(count);
    	count = count - 1;
    	$('#'+roi_count_id).html(count);
    }

    function add_image_with_rois_to_queue(specimen_pid, image_pid) {
    	$.get(drupal_url+"/apiary/workflow_ajax/add_image_with_rois_to_queue/"+workflow_id+"/"+image_pid+"/0", function(data){
			new_queue = $.trim(data);
			if(new_queue != "locked") {
				if(new_queue.indexOf('http_code = 400') > -1 || new_queue.indexOf('http_code = 503') > -1){
					//503 errors are typically due to apache or php being too busy on the back end to answer curl requests
					//400 are badly formed requests which can occur in our drupal calls due to php being too busy to gather data
					//so just request again until the server isn't too busy
					add_image_with_rois_to_queue(specimen_pid, image_pid);
				}
				else {
					$('#queue_list').append(new_queue);
					$.jGrowl('Your queue has been updated.');
					$(this).removeClass('available');
					$(this).addClass('queued');
				}
			}
			else {
			  $.jGrowl('CANNOT QUEUE: '+specimen_pid+' is currently locked by another user');
			  $(this).removeClass('available');
			  $(this).addClass('locked');
			}
		});
	}

    function add_images_with_rois_to_queue(image_array) {
    	if(image_array.length > 0)
    	{
    		var images = image_array.join(",");
    		$.getJSON(drupal_url+"/apiary/workflow_ajax/add_images_with_rois_to_queue/"+workflow_id+"/"+images+"/0", function(data){
				$('#queue_list').append(data.queue_html);
				$.jGrowl(data.message);
				update_info_sections();
				var queued_list = new Array();
				queued_list = (data.queued_list).split(",");
				$.each(queued_list, function(index, item) {
					$("#"+item).removeClass('available');
					$("#"+item).addClass('queued');
				});
				if(!$('.selected_specimen').length)
				{
					//var image_pid = $("#queue_list .specimen_name").first().attr("image_pid");
					//select_specimen(image_pid);

				}
				if(data.locked_list.length)
				{
					var locked_list = new Array();
					locked_list = (data.locked_list).split(",")
					$.each(locked_list, function(index, item) {
						$("#"+item).removeClass('available');
						$("#"+item).addClass('locked');
					});
				}
			});
		}
	}

	function add_next_item_to_queue()
	{
		//$.jGrowl('add_next_item_to_queue');

		var queued_count = 0;
		var specimen_pid = '';
		$.get(drupal_url+"/apiary/workflow_ajax/add_next_image_with_rois_to_queue/"+workflow_id+"/0/0", function(data, status, xhr){
			if (status == "error" && xhr.status != 0)
			{
				var msg = "Sorry but there was an error: ";
				//$.jGrowl(msg + xhr.status + " " + xhr.statusText);
			}
			//$.jGrowl(status+" "+xhr.status);
			new_queue = $.trim(data);
			if(new_queue != "locked")
			{
				$('#queue_list').append(new_queue);
				queued_count = queued_count + 1;
				$.jGrowl('Your queue has been updated.');
				$(this).removeClass('available');
				$(this).addClass('queued');
				if(!$('.selected_specimen').length)
				{
					var image_pid = $("#queue_list .specimen_name").first().attr("image_pid");
					select_specimen(image_pid);
				}
				update_info_sections();
			}
			else
			{
				$.jGrowl('CANNOT QUEUE: '+specimen_pid+' is currently locked by another user');
				$(this).removeClass('available');
				$(this).addClass('locked');
			}
		});
	}

    function init_queue()
    {
                //$.jGrowl('init_queue');

		var queued_count = 0;
    	var specimen_pid = '';
		$.get(drupal_url+"/apiary/workflow_ajax/get_images_with_rois_in_queue/"+workflow_id+"/0/0", function(data, status, xhr){
          if (status == "error" && xhr.status != 0)
          {
            var msg = "Sorry but there was an error: ";
            //$.jGrowl(msg + xhr.status + " " + xhr.statusText);
          }
                //$.jGrowl(status+" "+xhr.status);
			new_queue = $.trim(data);
			if(new_queue != "locked") {
			  $('#queue_list').append(new_queue);
			  queued_count = queued_count + 1;
			  $.jGrowl('Your queue has been updated.');
			  $(this).removeClass('available');
			  $(this).addClass('queued');
			  update_info_sections();
			}
			else {
			  $.jGrowl('CANNOT QUEUE: '+specimen_pid+' is currently locked by another user');
			  $(this).removeClass('available');
			  $(this).addClass('locked');
			}
		});
    }

    function end_session() {
		$.get(drupal_url+"/apiary/workflow_ajax/delete_session/"+workflow_id+"/0/0", function(data){
			var end_session_result = $.trim(data);
			if(end_session_result == "success") {
				$(location).attr('href',drupal_url+"/apiary");
			}
		});
    }

	function pause(milliseconds) {
		var dt = new Date();
		while ((new Date()) - dt <= milliseconds) {
			/* Do nothing */
		}
	}

    function end_session_original() {
		$.get(drupal_url+"/apiary/workflow_ajax/clear_session/"+workflow_id+"/0/0", function(data){
			var end_session_result = $.trim(data);
			if(end_session_result == "success") {
				//we can either reset everything to default looks
				//and swap item browser classes from queued to available
				//or we can redirect to a workflow list
				close_end_session();
				$(location).attr('href',drupal_url+"/apiary");
			}
		});
    }

    function close_end_session() {
    	$('button#end_session_link').colorbox.close();
    }

    function close_session_statistics() {
    	$('button#session_statistics_link').colorbox.close();
    }

    function remove_queue_item_from_queue(pid) {
		$.get(drupal_url+"/apiary/workflow_ajax/releaseLock/"+pid+"/0/0", function(data){
			var releaseLock_result = $.trim(data);
			if(releaseLock_result == "success") {
                $.jGrowl(pid+' was successfully removed from your work queue');

				//do your logic here
				if(pid.search("ap-roi") > -1) {
					set_queue_roi_as_available(pid);
				}
				else {
				    set_queue_specimen_as_available(pid);
					nice_pid = get_nice_id(pid);
					$('#'+nice_pid+'_queue').hide();
					$('#content-'+nice_pid).hide();
					$('#'+nice_pid+'_queue').remove();
					$('#content-'+nice_pid).remove();
				}
				update_info_sections();
			}
			else {
                $.jGrowl('There was an error removing '+pid+' from your work queue.');
			}
		});
    }

    function add_queue_roi_to_queue(image_pid, roi_pid) {
		$.get(drupal_url+"/apiary/workflow_ajax/add_queue_roi_to_queue/"+image_pid+"/"+roi_pid+"/"+workflow_id, function(data){
			var queue_roi_result = $.trim(data);
			if(queue_roi_result != "false") {
    			var queue_id = get_roi_queue_id(roi_pid);
    			if($('#'+queue_id).length==0){
    				$('#queue_list').append(queue_roi_result);
    			}
    			else {
    				set_queue_roi_as_queued(roi_pid);
    			}
    			update_info_sections();
			}
		});
    }

    function get_roi_queue_id(roi_pid) {
    	//OLD-ROI queue item main div id is in the form of widget-subcontent-ap-roi__ROI-1
    	//CURRENT-ROI queue item main div id is in the form of ap-roi__ROI-1_queue
    	roi_pid = roi_pid.replace('widget-subcontent-', '');//incase we pass the div id
    	var queue_id = roi_pid.replace(':', '__')+'_queue';
    	return queue_id;
    }

    function get_specimen_queue_id(specimen_pid) {
    	//CURRENT-Image queue item main div id is in the form of ap-roi__ROI-1_queue
    	var queue_id = specimen_pid.replace(':', '__')+'_queue';
    	return queue_id;
    }

    function get_roi_content_id(roi_pid) {
    	roi_pid = roi_pid.replace('widget-subcontent-', '');
    	var content_id = 'content-'+roi_pid.replace(':', '__');
    	return content_id;
    }

    function get_nice_id(pid) {
    	var nice_pid = pid.replace(':', '__');
    	return nice_pid;
    }

    function get_real_id(pid) {
        var real_pid = pid.replace('__',':').replace('_queue','');
        return real_pid;
    }

    function set_queue_specimen_as_available(specimen_pid) {
		var queue_id = get_specimen_queue_id(specimen_pid);
        $('#'+queue_id).removeClass('specimen_queued');
        $('#'+queue_id).removeClass('specimen_locked');
        $('#'+queue_id).addClass('specimen_available');
    }

    function set_queue_specimen_as_queued(specimen_pid) {
    	var queue_id = get_specimen_queue_id(specimen_pid);
        $('#'+queue_id).removeClass('specimen_available');
        $('#'+queue_id).removeClass('specimen_locked');
        $('#'+queue_id).addClass('specimen_queued');
    }

    function set_queue_specimen_as_locked(specimen_pid) {
    	var queue_id = get_specimen_queue_id(specimen_pid);
        $('#'+queue_id).removeClass('specimen_queued');
        $('#'+queue_id).removeClass('specimen_available');
        $('#'+queue_id).addClass('specimen_locked');
    }

    function set_queue_roi_as_available(roi_pid) {
		var queue_id = get_roi_queue_id(roi_pid);
    	$('#'+queue_id+' .transcribe_link').hide();
    	$('#'+queue_id+' .parse_link').hide();
    	$('#'+queue_id+' .queue_remove_link').hide();
    	$('#'+queue_id+' .queue_add_link').show();
    	$('#'+queue_id+' .queue_locked_by').hide();
        $('#'+queue_id).removeClass('roi_queued');
        $('#'+queue_id).removeClass('roi_locked');
        $('#'+queue_id).addClass('roi_available');
    }

    function set_queue_roi_as_queued(roi_pid) {
    	var queue_id = get_roi_queue_id(roi_pid);
    	$('#'+queue_id+' .transcribe_link').show();
    	$('#'+queue_id+' .parse_link').show();
    	$('#'+queue_id+' .queue_remove_link').show();
    	$('#'+queue_id+' .queue_add_link').hide();
    	$('#'+queue_id+' .queue_locked_by').hide();
        $('#'+queue_id).removeClass('roi_available');
        $('#'+queue_id).removeClass('roi_locked');
        $('#'+queue_id).addClass('roi_queued');
    }

    function set_queue_roi_as_locked(roi_pid) {
    	var queue_id = get_roi_queue_id(roi_pid);
    	$('#'+queue_id+' .transcribe_link').hide();
    	$('#'+queue_id+' .parse_link').hide();
    	$('#'+queue_id+' .queue_remove_link').hide();
    	$('#'+queue_id+' .queue_add_link').hide();
    	$('#'+queue_id+' .queue_locked_by').show();
        $('#'+queue_id).removeClass('roi_queued');
        $('#'+queue_id).removeClass('roi_available');
        $('#'+queue_id).addClass('roi_locked');
    }

    function set_browser_item_as_available() {
    }

    function set_browser_item_as_queued() {
    }

    function set_browser_item_as_locked() {
    }

    function help(section) {
        alert(section+' help');
    }

    function get_dom_position(object)
    {
        current_position = -1;
        //alert(object.attr('id'));
        //alert(object.parent('div').html());
        parent_node = object.parent('div');
        $('div#queue_list > div.widget-header').each( function(index) {
            //alert($(this).attr('id'));
           if ( object.attr('id') == $(this).attr('id') )
           {
                current_position = index;
            }
        });
        //current_position = object.index();
        return current_position;
    }

    function save_note()
    {
        alert('save_note');
        $('button#add_note_link').colorbox.close();
        $('#add_note_textarea').html('');
        $('#add_note_textarea').val('');
    }

    function cancel_note()
    {
        alert('cancel note');
        $('button#add_note_link').colorbox.close();
        $('#add_note_textarea').val('');
    }

    function change_status()
    {
        var stage = get_stage();

        var status_type = '';
        var pid = '';
        if ( stage == 'transcribe' )
        {
            status_type = 'transcribedStatus';
            pid = get_real_id(get_selected_roi());
        }
        else if ( stage == 'parse' )
        {
            status_type = 'parsedL1Status';
            pid = get_real_id(get_selected_roi());
        }
        else
        {
            status_type = 'analyzedStatus';
            pid = get_selected_image_pid();
        }
		var status = $('#object_status').val();
        if ( status != 'select a status' )
        {
            if ( pid == '' )
            {
                if ( stage == 'transcribe' )
               		$.jGrowl('There was no Image object selected.');
                else if ( stage == 'parse' )
               		$.jGrowl('There was no Image object selected.');
                else
               		$.jGrowl('There was no ROI object selected.');
            }
            else
            {
        		var url = "/apiary/workflow_ajax/updateStatus/"+pid+"/"+status_type+"/"+escape(status);
        		$.jGrowl('updating the status of '+pid);
        		$.get(drupal_url+url, function(data){
        			if ( $.trim(data) == '<status_successfully_updated>true</status_successfully_updated>' )
        			{
                		var status_string = $('#object_status').val();
                		if ( stage == 'parse' )
            			    set_selected_roi_parse_status(status_string);
                		else if ( stage == 'transcribe' )
            			    set_selected_roi_transcribe_status(status_string);
            			else
            			    set_selected_image_status(status_string);
                		$.jGrowl('status changed to '+status_string);
        			}
        			else
        		    {
                		$.jGrowl('There was an error updating the status for'+get_selected_image_pid());
        		    }
        		});
                //apiary?ref=updateStatus&image_pid=ap-specimen:Specimen-1&status_type=analyzedStatus&status=completed
            }
        }
    }

    function get_stage()
    {
        var stage = '';
        if ( $('#step2').hasClass('selected') )
            stage = 'transcribe';
        else if ( $('#step3').hasClass('selected') )
            stage = 'parse';
        else
            stage = 'analysis';
        return stage;
    }

    function get_selected_specimen_pid()
    {
        specimen_pid = $('.selected_specimen > .widget-header-left > .specimen_name').attr('specimen_pid');
        return specimen_pid;
    }

    function get_selected_image_pid()
    {
        image_pid = $('.selected_specimen > .widget-header-left > .specimen_name').attr('image_pid');
        return image_pid;
    }

    function get_parent_pid(roi_pid)
    {
        var parent = $(roi_pid).parent('div').attr('id');
        parent = parent.replace('content-', '')
        //if ( parent != '' )
        //    parent = parent+'-queue';

        return parent;
    }

    function set_selected_image_status(status_string)
    {
        $('.selected_specimen > .widget-header-left > .specimen_name > .specimen_status').html(" - "+status_string);
    }

    function set_selected_roi_transcribe_status(status_string)
    {
        $('.selected_roi .transcribe_status').html(status_string);
    }

    function set_selected_roi_parse_status(status_string)
    {
        $('.selected_roi .parse_status').html(status_string);
    }

    function select_roi(pid)
    {
        $.jGrowl(' selecting '+pid);
        var queue_id = get_roi_queue_id(pid);
        //alert(queue_id);
        parent_pid = get_parent_pid('#'+queue_id);
        image_pid = get_real_id(parent_pid);
        if(image_pid != OL_loaded_image_pid)
        {
        	select_specimen(image_pid, false);
        }
        $('.selected_roi').removeClass('selected_roi');
        $('#'+queue_id).addClass('selected_roi');
        var item = $('.selected_roi').attr('id');
        update_info_sections();
    }

    function get_selected_roi()
    {
        var item = $('.selected_roi').attr('id');
        //alert(item);
        return item;
    }

    function get_roi_name(pid)
    {
        roi_pid = $('.selected_roi > .widget-subheader > .roi_name').attr('roi_pid');
        //alert(roi_pid);
        var roi = '';
        if ( roi_pid != null )
            roi = roi_pid.replace('ap-roi:','');
        return roi;
    }

    function resize_east_pane()
    {
        var stage = get_stage();
        if ( stage == 'transcribe' )
        {
            var pane_height = $('.ui-layout-east').height();
            $('textarea#transcribe_control').height(pane_height-120);
            $('iframe#transcribe_control').height(pane_height-120);
        }
        else if ( stage == 'analysis' )
        {
            var pane_width = $('.ui-layout-east').width();
            //alert(pane_width);
            $('.roi-controls').width(pane_width-138);
            //alert($('.roi-controls').width());
        }
        $('#parse_buttons').css('top',$('#step3_east_section').height());
        $('#parse-control-content').css('height',$('#step3_east_section').height()-60);
        resize_center_panel();
    }

    function resize_west_pane()
    {
        resize_center_panel();
    }

    var update_center_controls_timer;
    function update_center_controls()
    {
        clearInterval(update_center_controls_timer);
        adjust_openlayers_controls();
    }
    function resize_center_panel()
    {
        if ( update_center_controls_timer == null )
            update_center_controls_timer = setInterval(update_center_controls,200);
        adjust_center_overflow();
    }

    function transcribe_roi(pid)
    {
    	if(pid != OL_current_transcribe_roi)
    	{
        	select_roi(pid);
        }
        select_nav('step2');
        load_transcribe_content(pid);
    }

    function show_east_page()
    {
        $.jGrowl('show east pane');
    }

    function show_queue_control_open()
    {
        resize_center_panel();
        $('#queue-info-control-text').html('open queue');
    }
    function show_queue_control_closed()
    {
        resize_center_panel();
        $('#queue-info-control-text').html('close queue');
    }

    function east_panel_opened()
    {
        resize_center_panel();
    }

    function east_panel_closed()
    {
        resize_center_panel();
    }

    function adjust_openlayers_controls()
    {
    	var frame_size = $(".ui-layout-center").css('width');
    	frame_size = parseInt(frame_size, 10) - 40;
		$(".olMap").css('width',frame_size+'px');
		$(".olControlPanZoom").css('left',frame_size+'px');
		$(".olControlEditingToolbar").css('left',frame_size+10+'px');
  		$(".olControlPanZoom").css('display','none');
		if ( map != undefined )
		{
    		$(".olControlEditingToolbar").css('display','block');
    		$("#myControls").css('display','block');
    	}
    	else
		{
    		$(".olControlEditingToolbar").css('display','none');
    		$("#myControls").css('display','none');
    	}
		//$(".olControlEditingToolbar").css('position','absolute');
		//$(".olControlEditingToolbar").css('top','10px');
		//$(".olControlEditingToolbar").css('left','10px');
		//$(".olControlLayerSwitcher").css('left',frame_size+10+'px');
		//$(".olControlLayerSwitcher").css('top','78px');
		if ( update_center_controls_timer != null )
            clearInterval(update_center_controls_timer);
		update_center_controls_timer = null;
    }

    function toggle_additem_button(state)
    {
        if ( state == 'down' )
            $("#west_page_additem_button").attr('src','assets/img/add_items_button_down.png');
        else
            $("#west_page_additem_button").attr('src','assets/img/add_items_button_dark.png');
    }

    function check_permission(permission_string)
    {
        var permission_found = false;
        if ( permission_list != null )
        {
            for( var i = 0; i < permission_list.selected_permission_list.length; ++i )
            {
                if ( permission_list.selected_permission_list[i] == permission_string )
                {
                    permission_found = true;
                    break;
                }
            }
        }
        return permission_found;
    }
</script>
{/literal}